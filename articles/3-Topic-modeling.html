<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="rfintext">
<title>3 Topic modeling • rfintext</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="3 Topic modeling">
<meta property="og:description" content="rfintext">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">rfintext</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/0-Preprocessing-PDF-docs.html">0 Preprocessing PDF-docs</a>
    <a class="dropdown-item" href="../articles/1-Asuntopoliittisten-ohjelmien-teko-kunnissa.html">1 Asuntopoliittisten ohjelmien teko kunnissa</a>
    <a class="dropdown-item" href="../articles/1-Data-preprocessing.html">1 Data preprocessing</a>
    <a class="dropdown-item" href="../articles/2-Document-term-matrix.html">2 Document term matrix</a>
    <a class="dropdown-item" href="../articles/3-Topic-modeling.html">3 Topic modeling</a>
    <a class="dropdown-item" href="../articles/4-Model-validation.html">4 Model validation</a>
    <a class="dropdown-item" href="../articles/5-Results.html">5 Results</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/StranMax/rfintext/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>3 Topic modeling</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/StranMax/rfintext/blob/HEAD/vignettes/articles/3-Topic-modeling.Rmd" class="external-link"><code>vignettes/articles/3-Topic-modeling.Rmd</code></a></small>
      <div class="d-none name"><code>3-Topic-modeling.Rmd</code></div>
    </div>

    
    
<p>Topic modeling with latent Dirichlet allocation (LDA).</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/StranMax/rfintext" class="external-link">rfintext</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://quanteda.io" class="external-link">quanteda</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/juliasilge/tidytext" class="external-link">tidytext</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">topicmodels</span><span class="op">)</span>  <span class="co"># LDA</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/doug-friedman/topicdoc" class="external-link">topicdoc</a></span><span class="op">)</span>  <span class="co"># Coherence score</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span>  <span class="co"># Tidyverse friends</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org" class="external-link">tidyr</a></span><span class="op">)</span>  <span class="co"># Tidyverse friends</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tibble.tidyverse.org/" class="external-link">tibble</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://forcats.tidyverse.org/" class="external-link">forcats</a></span><span class="op">)</span>  <span class="co"># Tidyverse friends</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://purrr.tidyverse.org/" class="external-link">purrr</a></span><span class="op">)</span>  <span class="co"># Tidyverse friends</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org" class="external-link">tidyr</a></span><span class="op">)</span>  <span class="co"># Tidyverse friends</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span>  <span class="co"># Tidyverse friends</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://wilkelab.org/cowplot/" class="external-link">cowplot</a></span><span class="op">)</span>  <span class="co"># Multiple plots made easy</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://future.futureverse.org" class="external-link">future</a></span><span class="op">)</span>  <span class="co"># Parallel processing back-end</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/DavisVaughan/furrr" class="external-link">furrr</a></span><span class="op">)</span>  <span class="co"># Parallel processing front-end with future_ functions</span></span>
<span><span class="fu"><a href="https://future.futureverse.org/reference/plan.html" class="external-link">plan</a></span><span class="op">(</span><span class="va">multisession</span>, workers <span class="op">=</span> <span class="fu"><a href="https://parallelly.futureverse.org/reference/availableCores.html" class="external-link">availableCores</a></span><span class="op">(</span>logical <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span>  <span class="co"># Utilize multiple cores on time consuming tasks.</span></span></code></pre></div>
<p>You know already how to pre process and convert to document term
matrix:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dtm</span> <span class="op">&lt;-</span> <span class="va">aspol</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/preprocess_corpus.html">preprocess_corpus</a></span><span class="op">(</span><span class="va">kunta</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html" class="external-link">count</a></span><span class="op">(</span><span class="va">kunta</span>, <span class="va">LEMMA</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tidytext/man/document_term_casters.html" class="external-link">cast_dfm</a></span><span class="op">(</span><span class="va">kunta</span>, <span class="va">LEMMA</span>, <span class="va">n</span><span class="op">)</span>  <span class="co"># n is default name from dplyr::count()</span></span>
<span><span class="va">dtm</span></span>
<span><span class="co">#&gt; Document-feature matrix of: 68 documents, 3,038 features (76.63% sparse) and 0 docvars.</span></span>
<span><span class="co">#&gt;              features</span></span>
<span><span class="co">#&gt; docs          A#talo Vapaa#aika aiheuttaa aika aika#väli ajatella alhainen alku alku#peräinen alku#puoli alue antaa arava#laina arava#rajoitus arvioida asettaa asia asiakas asian#mukainen asua</span></span>
<span><span class="co">#&gt;   Enontekiö        3          1         3    7         1        1        1    1             1          1   17     3           1              1        1       2    3       3              1    5</span></span>
<span><span class="co">#&gt;   Espoo            0          0         1   18         3        0        4    1             1          0  108     2           0              0        9      10    3       1              0   11</span></span>
<span><span class="co">#&gt;   Eura             0          0         1    5         0        0        1    0             0          0   10     1           0              0        3       1    1       6              0    7</span></span>
<span><span class="co">#&gt;   Hartola          0          1         2    5         0        0        0    0             0          0    4     0           0              0        3       0    0       0              0    6</span></span>
<span><span class="co">#&gt;   Hattula          0          0         0    6         0        0        0    1             0          0   17     1           0              0        0       1    1       0              0    3</span></span>
<span><span class="co">#&gt;   Helsinki         0          0         3   46         4        0        5   12             0          1  139     7           0              0       26      13    8       6              1   57</span></span>
<span><span class="co">#&gt;   Huittinen        2          0         0   13         1        5        2    0             0          0   16     3           0              0        4       3   13       4              0    8</span></span>
<span><span class="co">#&gt;   Hyvinkää         0          0         0    1         0        0        0    0             0          0    0     0           0              0        1       0    0       0              0    9</span></span>
<span><span class="co">#&gt;   Hämeenlinna      0          3         3    1         0        0        0    1             0          0   18     3           0              0        2       0   29       3              0   10</span></span>
<span><span class="co">#&gt;   Iitti            0          0         0    0         0        0        0    1             0          0   18     5           0              0        0       1    0       0              0    0</span></span>
<span><span class="co">#&gt;   Imatra           0          0         0    2         0        0        0    0             0          0    6     0           0              0        2       0    1       0              0   11</span></span>
<span><span class="co">#&gt;   Inkoo            0          0         1   11         1        0        1    2             0          0   26     4           0              0        0       5    2       0              0    3</span></span>
<span><span class="co">#&gt;   Joensuu          0          0         1   33         2        1        4    4             1          0  129     2           0              1        9      13    5       4              0   25</span></span>
<span><span class="co">#&gt;   Juva             0          0         2   13         5        0        2    3             0          0   19     2           1              0        1       2    2       3              0   10</span></span>
<span><span class="co">#&gt;   Järvenpää        0          0         0    2         0        0        0    0             0          0    7     1           0              0        0       3    2       0              0   11</span></span>
<span><span class="co">#&gt;   Kaarina          0          1         2   15         6        0        0    1             0          0   55     4           0              0        4       4    3       0              0    8</span></span>
<span><span class="co">#&gt;   Kalajoki         0          0         0    1         0        0        0    0             0          0    5     0           0              0        2       0    0       0              0    0</span></span>
<span><span class="co">#&gt;   Kauniainen       0          0         2   14         0        1        0    1             0          1  104     4           0              0       12       6    1       3              0   17</span></span>
<span><span class="co">#&gt;   Kemiönsaari      0          3         3   12         1        1        1    3             2          0  136    14           0              0        3       3    1       2              0    8</span></span>
<span><span class="co">#&gt;   Kerava           0          0         2    0         0        0        0    0             0          0   13     3           0              0        2       5    0       0              0    0</span></span>
<span><span class="co">#&gt; [ reached max_ndoc ... 48 more documents, reached max_nfeat ... 3,018 more features ]</span></span></code></pre></div>
<p>Let’s get straight to business. Unsupervised classification with
LDA:</p>
<p>LDA needs one parameter <code>k</code>. Finding optimal values by
evaluating coherence score.</p>
<p>Here we use the pre calculated data set <code>lda_models</code>
because running classification every time wastes time. Data set
<code>lda_models</code> includes mean semantic coherence calclulated
with different topic sizes and random seeds.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">rfintext</span><span class="fu">::</span><span class="va"><a href="../reference/lda_models.html">lda_models</a></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 1,400 × 3</span></span></span>
<span><span class="co">#&gt;        K       S mean_coherence</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>     3 3<span style="text-decoration: underline;">146</span>759          -<span style="color: #BB0000;">9.41</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>     3 3<span style="text-decoration: underline;">815</span>732          -<span style="color: #BB0000;">7.86</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>     3 7<span style="text-decoration: underline;">380</span>638          -<span style="color: #BB0000;">5.34</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>     3 8<span style="text-decoration: underline;">592</span>264          -<span style="color: #BB0000;">6.60</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>     3 1<span style="text-decoration: underline;">442</span>259          -<span style="color: #BB0000;">7.08</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>     3 1<span style="text-decoration: underline;">651</span>155          -<span style="color: #BB0000;">7.13</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>     3 9<span style="text-decoration: underline;">578</span>454          -<span style="color: #BB0000;">6.74</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>     3 2<span style="text-decoration: underline;">653</span>332          -<span style="color: #BB0000;">6.09</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>     3 1<span style="text-decoration: underline;">929</span>552         -<span style="color: #BB0000;">10.8</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>     3 6<span style="text-decoration: underline;">003</span>578          -<span style="color: #BB0000;">8.37</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 1,390 more rows</span></span></span></code></pre></div>
<p>Below is the code used to run the models.</p>
<blockquote>
<p>Note! Following will take some time on normal computer. On cloud
computing environment with 40 core machine with 177 Gb of RAM this took
less than one hour. If running locally adjust number of K and S values
accordingly.</p>
</blockquote>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># set.seed(342024)</span></span>
<span><span class="co"># random_seeds &lt;- sample.int(9999999, 10)  # 3476154 5039353 8550496 7292293 5500417 7137547 6622604 9458765 3952778 8167640</span></span>
<span><span class="co">#</span></span>
<span><span class="co"># ptm &lt;- proc.time()</span></span>
<span><span class="co"># lda_models &lt;- expand_grid(K = 3:30, S = random_seeds) |&gt;</span></span>
<span><span class="co">#   mutate(</span></span>
<span><span class="co">#     # LDA models</span></span>
<span><span class="co">#     lda = future_map2(</span></span>
<span><span class="co">#       K, S, \(k, s)  {</span></span>
<span><span class="co">#         LDA(convert(bow, to = "tm"), k = k, control = list(seed = s))</span></span>
<span><span class="co">#       },</span></span>
<span><span class="co">#       .options = furrr_options(seed = NULL)</span></span>
<span><span class="co">#     ),</span></span>
<span><span class="co">#     # Model coherence</span></span>
<span><span class="co">#     mean_coherence = future_map_dbl(</span></span>
<span><span class="co">#       lda, \(x) {</span></span>
<span><span class="co">#         mean(topic_coherence(x, bow))</span></span>
<span><span class="co">#       }</span></span>
<span><span class="co">#     )</span></span>
<span><span class="co">#   )</span></span>
<span><span class="co"># proc.time() - ptm</span></span>
<span><span class="co"># lda_models</span></span></code></pre></div>
<blockquote>
<p>Note. Now there is function
<code><a href="../reference/calculate_semantic_coherence.html">rfintext::calculate_semantic_coherence()</a></code> for the same
task</p>
</blockquote>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p</span> <span class="op">&lt;-</span> <span class="va">lda_models</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">K</span>, y <span class="op">=</span> <span class="va">mean_coherence</span>, group <span class="op">=</span> <span class="va">S</span>, colour <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">S</span><span class="op">)</span>, fill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">S</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>show.legend <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>show.legend <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_colour_discrete.html" class="external-link">scale_color_discrete</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>subtitle <span class="op">=</span> <span class="st">"LDA model coherence with different topic numbers"</span>, </span>
<span>       x <span class="op">=</span> <span class="st">"k (number of topics)"</span>, y <span class="op">=</span> <span class="st">"Mean coherence"</span><span class="op">)</span></span>
<span><span class="va">p</span></span></code></pre></div>
<p><img src="3-Topic-modeling_files/figure-html/unnamed-chunk-6-1.png" width="700"></p>
<p>Visually selecting potentially best k value/values. Coherence decline
seems to stop and even slightly increase when k is over 10. Let’s pick
value 15 for k since there is also less variation.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lda_models</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>variation <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">var</a></span><span class="op">(</span><span class="va">mean_coherence</span><span class="op">)</span>, .by <span class="op">=</span> <span class="va">K</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">variation</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 28 × 2</span></span></span>
<span><span class="co">#&gt;        K variation</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>    13     0.303</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>    21     0.306</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>    17     0.313</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>    16     0.314</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>    22     0.334</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>    15     0.365</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>    23     0.409</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>    14     0.411</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>    20     0.416</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>    24     0.443</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 18 more rows</span></span></span></code></pre></div>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># optimal_k &lt;- c(5, 9, 11, 15, 20)</span></span>
<span><span class="co"># optimal_k &lt;- c(5, 7, 10, 15, 21)</span></span>
<span><span class="co"># optimal_k &lt;- c(3, 5, 15)</span></span>
<span><span class="va">optimal_k</span> <span class="op">&lt;-</span> <span class="fl">13</span></span></code></pre></div>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="va">optimal_k</span>, linetype<span class="op">=</span><span class="st">'dashed'</span>, color<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'red'</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">optimal_k</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_text.html" class="external-link">geom_text</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">x</span><span class="op">+</span><span class="fl">1</span>, label<span class="op">=</span><span class="va">x</span>, y<span class="op">=</span><span class="op">-</span><span class="fl">5</span><span class="op">)</span>, colour<span class="op">=</span><span class="st">"red"</span>, angle<span class="op">=</span><span class="fl">90</span><span class="op">)</span><span class="op">}</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>subtitle <span class="op">=</span> <span class="st">"Optimal k values"</span>,</span>
<span>       x <span class="op">=</span> <span class="st">"k (number of topics)"</span>, y <span class="op">=</span> <span class="st">"Mean coherence"</span><span class="op">)</span></span></code></pre></div>
<p><img src="3-Topic-modeling_files/figure-html/unnamed-chunk-9-1.png" width="700"></p>
<blockquote>
<p>NOTE! Coherence scores can change even for smallest adjustments to
pre processing pipeline. Make your mind on those first and stick to
it.</p>
</blockquote>
<p>Highest coherence values: 13</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">optimal_params</span> <span class="op">&lt;-</span> <span class="va">lda_models</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">K</span> <span class="op">==</span> <span class="fl">13</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice_min</a></span><span class="op">(</span><span class="va">mean_coherence</span>, n <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">optimal_params</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 1 × 3</span></span></span>
<span><span class="co">#&gt;       K      S mean_coherence</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>    13 <span style="text-decoration: underline;">664</span>224          -<span style="color: #BB0000;">12.6</span></span></span></code></pre></div>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">selected_models</span> <span class="op">&lt;-</span> <span class="va">optimal_params</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>lda <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map2.html" class="external-link">map2</a></span><span class="op">(</span><span class="va">K</span>, <span class="va">S</span>, \<span class="op">(</span><span class="va">k</span>, <span class="va">s</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/topicmodels/man/lda.html" class="external-link">LDA</a></span><span class="op">(</span><span class="va">dtm</span>, k <span class="op">=</span> <span class="va">k</span>, control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>seed <span class="op">=</span> <span class="va">s</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">selected_models</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 1 × 4</span></span></span>
<span><span class="co">#&gt;       K      S mean_coherence lda      </span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>    13 <span style="text-decoration: underline;">664</span>224          -<span style="color: #BB0000;">12.6</span> <span style="color: #949494;">&lt;LDA_VEM&gt;</span></span></span></code></pre></div>
<p>If multiple models:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># ptm &lt;- proc.time()</span></span>
<span><span class="co"># selected_models &lt;- optimal_params |&gt;</span></span>
<span><span class="co">#   mutate(</span></span>
<span><span class="co">#     lda = future_map2(K, S, \(k, s) {</span></span>
<span><span class="co">#       LDA(convert(dtm, to = "tm"), k = k, control = list(seed = s))</span></span>
<span><span class="co">#     }, .options = furrr_options(seed = NULL))</span></span>
<span><span class="co">#   )</span></span>
<span><span class="co"># proc.time() - ptm</span></span>
<span><span class="co"># selected_models</span></span></code></pre></div>
<p>Extract beta and theta matrices with probabilities for terms per
topic and documents per topic repectively.</p>
<blockquote>
<p>Note! <code><a href="https://generics.r-lib.org/reference/tidy.html" class="external-link">tidytext::tidy()</a></code> uses term gamma-matrix while in
the research field term theta-matrix is used to describe probability
distribution of topics per document. Here we rename gamma as theta. Do
not get confused if at some point you come around with gamma instead of
theta.</p>
</blockquote>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">selected_models</span> <span class="op">&lt;-</span> <span class="va">selected_models</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    <span class="co"># Beta matrix</span></span>
<span>    beta <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span></span>
<span>      <span class="va">lda</span>, \<span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html" class="external-link">tidy</a></span><span class="op">(</span><span class="va">x</span>, matrix <span class="op">=</span> <span class="st">"beta"</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    <span class="co"># Theta matrix (gamma)</span></span>
<span>    theta <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span></span>
<span>      <span class="va">lda</span>, \<span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html" class="external-link">tidy</a></span><span class="op">(</span><span class="va">x</span>, matrix <span class="op">=</span> <span class="st">"gamma"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>          <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>theta <span class="op">=</span> <span class="va">gamma</span><span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="va">selected_models</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 1 × 6</span></span></span>
<span><span class="co">#&gt;       K      S mean_coherence lda       beta                  theta             </span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>                <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>            </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>    13 <span style="text-decoration: underline;">664</span>224          -<span style="color: #BB0000;">12.6</span> <span style="color: #949494;">&lt;LDA_VEM&gt;</span> <span style="color: #949494;">&lt;tibble [39,494 × 3]&gt;</span> <span style="color: #949494;">&lt;tibble [884 × 3]&gt;</span></span></span></code></pre></div>
<p>Let’s try to calculate how much there is similarity vs difference in
topics between different models.</p>
<blockquote>
<p>TODO: Set probabilities of all but the top 10-40 terms to zero and
calculate cosine similarity between all topic pairs.</p>
</blockquote>
<blockquote>
<p>Note. Only one model, skip following:</p>
</blockquote>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># selected_models &lt;- selected_models |&gt; filter(K==5)</span></span>
<span><span class="co"># selected_models &lt;- selected_models |&gt; mutate(model_id = paste0(K, "_", S))</span></span>
<span><span class="co"># idx &lt;- combn(unique(selected_models$model_id), 2)  # Unique pairs of K</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># beta &lt;- selected_models |&gt; select(K, model_id, beta)</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># topic_pairs &lt;- list()</span></span>
<span><span class="co"># for (i in 1:ncol(idx)) {</span></span>
<span><span class="co">#   sel &lt;- beta |&gt; filter(model_id %in% idx[, i])  # Two rows at a time</span></span>
<span><span class="co">#   </span></span>
<span><span class="co">#   # Combine pair of rows to same row</span></span>
<span><span class="co">#   topic_pairs[[i]] &lt;- tibble_row(</span></span>
<span><span class="co">#     K1 = sel[[1,"K"]], model1 = sel[[1,"model_id"]], beta1 = sel[[1,"beta"]],</span></span>
<span><span class="co">#     K2 = sel[[2,"K"]], model2 = sel[[2,"model_id"]], beta2 = sel[[2,"beta"]]</span></span>
<span><span class="co">#     )</span></span>
<span><span class="co">#   </span></span>
<span><span class="co"># }</span></span>
<span><span class="co"># topic_pairs &lt;- bind_rows(topic_pairs)</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># topic_pairs &lt;- topic_pairs |&gt;</span></span>
<span><span class="co">#   mutate(</span></span>
<span><span class="co">#     </span></span>
<span><span class="co">#     topics1 = map(beta1, \(b1) {</span></span>
<span><span class="co">#       b1 |&gt;</span></span>
<span><span class="co">#         pivot_wider(values_from = beta, names_from = topic) |&gt;</span></span>
<span><span class="co">#         select(-term)</span></span>
<span><span class="co">#     }),</span></span>
<span><span class="co">#     </span></span>
<span><span class="co">#     topics2 = map(beta2, \(b2) {</span></span>
<span><span class="co">#       b2 |&gt;</span></span>
<span><span class="co">#         pivot_wider(values_from = beta, names_from = topic) |&gt;</span></span>
<span><span class="co">#         select(-term)</span></span>
<span><span class="co">#     }),</span></span>
<span><span class="co">#     </span></span>
<span><span class="co">#     r = map2(topics1, topics2, \(x1, x2) {</span></span>
<span><span class="co">#       cor(x1, x2)</span></span>
<span><span class="co">#     })#,</span></span>
<span><span class="co">#     </span></span>
<span><span class="co">#     # cossim = map2(topics1, topics2, \(x1, x2) {</span></span>
<span><span class="co">#     #   cosine(x1, x2)</span></span>
<span><span class="co">#     # })</span></span>
<span><span class="co">#   )</span></span>
<span><span class="co"># topic_pairs</span></span></code></pre></div>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># topic_pairs |&gt; select(K1, K2, r) |&gt;</span></span>
<span><span class="co">#   mutate(similarity = map(r, \(x) {</span></span>
<span><span class="co">#     x |&gt;</span></span>
<span><span class="co">#       as_tibble(rownames = "topic1") |&gt;</span></span>
<span><span class="co">#       pivot_longer(!topic1, names_to = "topic2", values_to = "r") |&gt;</span></span>
<span><span class="co">#       summarise(similarity = sum(r &gt; 0.8)/n(), .by = topic1)</span></span>
<span><span class="co">#   })) |&gt;</span></span>
<span><span class="co">#   select(-r) |&gt;</span></span>
<span><span class="co">#   unnest(similarity) |&gt;</span></span>
<span><span class="co">#   summarise(mean_similarity = mean(similarity), .by = c(K1, topic1)) |&gt;</span></span>
<span><span class="co">#   mutate(topic1 = as.factor(as.integer(topic1))) |&gt;</span></span>
<span><span class="co">#   ggplot() +</span></span>
<span><span class="co">#   geom_col(aes(x = topic1, y = mean_similarity)) +</span></span>
<span><span class="co">#   facet_grid(~K1, scales = "free_x")</span></span></code></pre></div>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># similarity &lt;- list()</span></span>
<span><span class="co"># for (i in 1:nrow(topic_pairs)) {</span></span>
<span><span class="co">#   similarity[[i]] &lt;- topic_pairs$r[[i]] |&gt;</span></span>
<span><span class="co">#     as_tibble(rownames = "topic1") |&gt;</span></span>
<span><span class="co">#     pivot_longer(!topic1, names_to = "topic2", values_to = "r") |&gt;</span></span>
<span><span class="co">#     summarise(similarity = sum(r &gt; 0.9)/n(), .by = topic1)  </span></span>
<span><span class="co"># }</span></span>
<span><span class="co"># bind_rows(similarity) |&gt;</span></span>
<span><span class="co">#   summarise(mean_similarity = mean(similarity), .by = topic1)</span></span></code></pre></div>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># topic_congruence &lt;- list()</span></span>
<span><span class="co"># for (i in 1:nrow(topic_pairs)) {</span></span>
<span><span class="co">#   topic_congruence[[i]] &lt;- topic_pairs$r[[i]] |&gt;</span></span>
<span><span class="co">#   as_tibble(rownames = "model1") |&gt;</span></span>
<span><span class="co">#   pivot_longer(cols = !model1, names_to = "model2", values_to = "r") |&gt;</span></span>
<span><span class="co">#   ggplot(aes(x = model1, y = model2, fill = r, label = round(r, 2))) +</span></span>
<span><span class="co">#   geom_tile(show.legend = FALSE) +</span></span>
<span><span class="co">#   geom_text() +</span></span>
<span><span class="co">#   scale_fill_gradient2(low = "blue", mid = "white", high = "red")  </span></span>
<span><span class="co"># }</span></span>
<span><span class="co"># plot_grid(plotlist = topic_congruence)</span></span></code></pre></div>
<p>Next parts look ugly but hopefully they work. We take a look at
correlation between topics from different models to see if different
models catch up same things.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># topic_congruence &lt;- list()</span></span>
<span><span class="co"># for (i in selected_models$K) {</span></span>
<span><span class="co">#   topic_congruence[[paste0("model-", i)]] &lt;- selected_models |&gt;</span></span>
<span><span class="co">#   select(K, beta) |&gt;</span></span>
<span><span class="co">#   unnest(beta) |&gt;</span></span>
<span><span class="co">#   filter(K==i) |&gt;</span></span>
<span><span class="co">#   pivot_wider(values_from = beta, names_from = topic) |&gt;</span></span>
<span><span class="co">#   select(-term, -K)</span></span>
<span><span class="co"># }</span></span>
<span><span class="co"># topic_congruence</span></span></code></pre></div>
<p>Compare all possible pairs of models:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># combn(selected_models$K, 2)</span></span></code></pre></div>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># topic_congruence2 &lt;- list()</span></span>
<span><span class="co"># for (idx_col in 1:ncol(combn(selected_models$K, 2))) {</span></span>
<span><span class="co">#   idx &lt;- combn(selected_models$K, 2)[, idx_col]</span></span>
<span><span class="co">#   correlation &lt;- cor(topic_congruence[[paste0("model-", idx[1])]], topic_congruence[[paste0("model-", idx[2])]])</span></span>
<span><span class="co">#   topic_congruence2[[paste0("model-", idx[1], "-", idx[2])]] &lt;- correlation |&gt; </span></span>
<span><span class="co">#     as_tibble(rownames = "topic1") |&gt;</span></span>
<span><span class="co">#     pivot_longer(!topic1, names_to = "topic2", values_to = "r")</span></span>
<span><span class="co"># }</span></span>
<span><span class="co"># topic_congruence2 &lt;- bind_rows(topic_congruence2, .id = "model-K")</span></span>
<span><span class="co"># topic_congruence2</span></span></code></pre></div>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># topic_congruence2 |&gt;</span></span>
<span><span class="co">#   mutate(`model-K`= factor(`model-K`),</span></span>
<span><span class="co">#          topic1 = factor(as.integer(topic1)),</span></span>
<span><span class="co">#          topic2 = factor(as.integer(topic2)),</span></span>
<span><span class="co">#          r = round(r, 2)) |&gt;</span></span>
<span><span class="co">#   ggplot(aes(x = topic1, y = topic2, fill = r, label = r)) +</span></span>
<span><span class="co">#   geom_tile(show.legend = FALSE) +</span></span>
<span><span class="co">#   geom_text() +</span></span>
<span><span class="co">#   theme(axis.text.x = element_text(angle = 90)) +</span></span>
<span><span class="co">#   labs(title = "Topic congruence between different models") +</span></span>
<span><span class="co">#   scale_fill_viridis_c(option = "A") +</span></span>
<span><span class="co">#   facet_wrap(~`model-K`, scales = "free", ncol = 2)</span></span></code></pre></div>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># final_models &lt;- selected_models |&gt;</span></span>
<span><span class="co">#   slice_max(mean_coherence, n = 1, by = K)</span></span>
<span><span class="va">final_models</span> <span class="op">&lt;-</span> <span class="va">selected_models</span></span></code></pre></div>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">final_models</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">K</span>, <span class="va">theta</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/unnest.html" class="external-link">unnest</a></span><span class="op">(</span><span class="va">theta</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>topic <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">topic</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>mean_theta <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">theta</span><span class="op">)</span>,</span>
<span>            total_theta <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">theta</span><span class="op">)</span>, .by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">K</span>, <span class="va">topic</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html" class="external-link">geom_col</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">topic</span>, y <span class="op">=</span> <span class="va">total_theta</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Topic prevalence"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">K</span>, scales <span class="op">=</span> <span class="st">"free"</span><span class="op">)</span></span></code></pre></div>
<p><img src="3-Topic-modeling_files/figure-html/unnamed-chunk-23-1.png" width="1152"></p>
<p>Theta value is probability of document belonging to or comprising of
certain topics. Histogram over topic probabilities shows how common it
is for specific topic to comprise the whole document (height of a column
at theta 1.0).</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># final_models |&gt;</span></span>
<span><span class="co">#   select(K, theta) |&gt;</span></span>
<span><span class="co">#   unnest(theta) |&gt;</span></span>
<span><span class="co">#   ggplot(aes(x = theta, fill = K)) +</span></span>
<span><span class="co">#   geom_histogram(binwidth = 0.1, show.legend = FALSE) +</span></span>
<span><span class="co">#   labs(title = "Topic histograms") +</span></span>
<span><span class="co">#   theme(axis.text.x = element_text(angle = 90)) +</span></span>
<span><span class="co">#   facet_wrap(K~topic, scales = "free_y")</span></span></code></pre></div>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">final_models</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">K</span>, <span class="va">theta</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/unnest.html" class="external-link">unnest</a></span><span class="op">(</span><span class="va">theta</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice_max</a></span><span class="op">(</span><span class="va">theta</span>, n <span class="op">=</span> <span class="fl">1</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">K</span>, <span class="va">document</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>topic <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">topic</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">topic</span>, y <span class="op">=</span> <span class="va">theta</span>, group <span class="op">=</span> <span class="va">topic</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html" class="external-link">geom_boxplot</a></span><span class="op">(</span>show.legend <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Distributions of largest topics per document"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">K</span>, scales <span class="op">=</span> <span class="st">"free"</span><span class="op">)</span></span></code></pre></div>
<p><img src="3-Topic-modeling_files/figure-html/unnamed-chunk-25-1.png" width="1152"></p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># final_models |&gt;</span></span>
<span><span class="co">#   select(K, theta) |&gt;</span></span>
<span><span class="co">#   unnest(theta) |&gt;</span></span>
<span><span class="co">#   mutate(topic = factor(as.integer(topic))) |&gt;</span></span>
<span><span class="co">#   ggplot(aes(x = topic, y = theta, group = topic)) +</span></span>
<span><span class="co">#   geom_boxplot(show.legend = FALSE) +</span></span>
<span><span class="co">#   labs(title = "Topic distributions per document") +</span></span>
<span><span class="co">#   facet_wrap(~K, scales = "free")</span></span></code></pre></div>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">final_models</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">K</span>, <span class="va">beta</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/unnest.html" class="external-link">unnest</a></span><span class="op">(</span><span class="va">beta</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice_max</a></span><span class="op">(</span><span class="va">beta</span>, n <span class="op">=</span> <span class="fl">25</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">K</span>, <span class="va">topic</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">K</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html" class="external-link">add_count</a></span><span class="op">(</span><span class="va">term</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>is_unique <span class="op">=</span> <span class="va">n</span> <span class="op">==</span> <span class="fl">1</span>,</span>
<span>         K <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">K</span><span class="op">)</span>,</span>
<span>         topic <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">topic</span><span class="op">)</span>,</span>
<span>         term <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/tidytext/man/reorder_within.html" class="external-link">reorder_within</a></span><span class="op">(</span><span class="va">term</span>, <span class="va">beta</span>, <span class="va">topic</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">beta</span>, y <span class="op">=</span> <span class="va">term</span>, fill <span class="op">=</span> <span class="va">K</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html" class="external-link">geom_col</a></span><span class="op">(</span>show.legend <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"25 terms with highest probability per topic"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tidytext/man/reorder_within.html" class="external-link">scale_y_reordered</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="va">K</span> <span class="op">~</span> <span class="va">topic</span>, scales <span class="op">=</span> <span class="st">"free"</span><span class="op">)</span></span></code></pre></div>
<p><img src="3-Topic-modeling_files/figure-html/unnamed-chunk-27-1.png" width="1344"></p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">final_models</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">K</span>, <span class="va">beta</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/unnest.html" class="external-link">unnest</a></span><span class="op">(</span><span class="va">beta</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice_max</a></span><span class="op">(</span><span class="va">beta</span>, n <span class="op">=</span> <span class="fl">25</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">K</span>, <span class="va">topic</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">K</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html" class="external-link">add_count</a></span><span class="op">(</span><span class="va">term</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>is_unique <span class="op">=</span> <span class="va">n</span> <span class="op">==</span> <span class="fl">1</span>,</span>
<span>         K <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">K</span><span class="op">)</span>,</span>
<span>         topic <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">topic</span><span class="op">)</span>,</span>
<span>         term <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/tidytext/man/reorder_within.html" class="external-link">reorder_within</a></span><span class="op">(</span><span class="va">term</span>, <span class="va">beta</span>, <span class="va">topic</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">is_unique</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">beta</span>, y <span class="op">=</span> <span class="va">term</span>, fill <span class="op">=</span> <span class="va">K</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html" class="external-link">geom_col</a></span><span class="op">(</span>show.legend <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"25 terms with highest probability per topic"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/tidytext/man/reorder_within.html" class="external-link">scale_y_reordered</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="va">K</span> <span class="op">~</span> <span class="va">topic</span>, scales <span class="op">=</span> <span class="st">"free"</span><span class="op">)</span></span></code></pre></div>
<p><img src="3-Topic-modeling_files/figure-html/unnamed-chunk-28-1.png" width="1344"></p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># for (i in unique(beta_matrix$model)) {</span></span>
<span><span class="co">#   print(</span></span>
<span><span class="co">#     beta_matrix |&gt;</span></span>
<span><span class="co">#       filter(model == i) |&gt;</span></span>
<span><span class="co">#       group_by(topic) |&gt;</span></span>
<span><span class="co">#       slice_max(beta, n = 25) |&gt;</span></span>
<span><span class="co">#       mutate(topic = as.factor(paste0("Topic_", topic))) |&gt;</span></span>
<span><span class="co">#       ggplot(aes(x = beta, y = reorder(term, beta), fill = topic)) +</span></span>
<span><span class="co">#       geom_col(show.legend = FALSE) +</span></span>
<span><span class="co">#       scale_fill_viridis_d(option = "A") +</span></span>
<span><span class="co">#       facet_wrap(~topic, scales = "free") +</span></span>
<span><span class="co">#       labs(title = "Top 25 terms by topic", subtitle = paste0("Model_", i), x = "Probability", y = "Term")</span></span>
<span><span class="co">#   )</span></span>
<span><span class="co"># }</span></span></code></pre></div>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># for (i in unique(beta_matrix$model)) {</span></span>
<span><span class="co">#   print(</span></span>
<span><span class="co">#     beta_matrix |&gt;</span></span>
<span><span class="co">#       filter(model == i) |&gt;</span></span>
<span><span class="co">#       group_by(topic) |&gt;</span></span>
<span><span class="co">#       slice_max(beta, n = 25) |&gt;</span></span>
<span><span class="co">#       mutate(topic = as.factor(paste0("Topic_", topic))) |&gt;</span></span>
<span><span class="co">#       ungroup() |&gt;</span></span>
<span><span class="co">#       add_count(term, name = "in_topics") |&gt;</span></span>
<span><span class="co">#       filter(in_topics == 1) |&gt;</span></span>
<span><span class="co">#       ggplot(aes(x = beta, y = reorder(term, beta), fill = topic)) +</span></span>
<span><span class="co">#       geom_col(show.legend = FALSE) +</span></span>
<span><span class="co">#       scale_fill_viridis_d(option = "A") +</span></span>
<span><span class="co">#       facet_wrap(~topic, scales = "free", ncol = 2) +</span></span>
<span><span class="co">#       labs(title = "Unique terms out of top 25 terms by topic", subtitle = paste0("Model_", i), x = "Probability", y = "Term")</span></span>
<span><span class="co">#   )</span></span>
<span><span class="co"># }</span></span></code></pre></div>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># doc_topics &lt;- lapply(lda_models, function(x) {</span></span>
<span><span class="co">#   x |&gt;</span></span>
<span><span class="co">#     tidytext::tidy(matrix = "gamma") |&gt;</span></span>
<span><span class="co">#     tidytext::cast_dfm(document, topic, gamma)</span></span>
<span><span class="co"># })</span></span>
<span><span class="co"># doc_topics</span></span></code></pre></div>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># join_y &lt;- function(df) {</span></span>
<span><span class="co">#   df |&gt;</span></span>
<span><span class="co">#     left_join(taantuvat, by = join_by("doc_id" == "kunta")) |&gt;</span></span>
<span><span class="co">#     filter(!is.na(luokka))</span></span>
<span><span class="co"># }</span></span></code></pre></div>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># summarise_topics &lt;- function(df, ...) {</span></span>
<span><span class="co">#   df |&gt;</span></span>
<span><span class="co">#     mutate(topic = factor(as.integer(topic))) |&gt;</span></span>
<span><span class="co">#     summarise(...)</span></span>
<span><span class="co"># }</span></span></code></pre></div>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># plot_topic_mean_prop &lt;- function(df, ...) {</span></span>
<span><span class="co">#   df |&gt;</span></span>
<span><span class="co">#     ggplot() +</span></span>
<span><span class="co">#     geom_point(aes(...))</span></span>
<span><span class="co"># }</span></span></code></pre></div>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># lapply(doc_topics, function(x) { </span></span>
<span><span class="co">#   x |&gt;</span></span>
<span><span class="co">#     gather_topic_prob() |&gt;</span></span>
<span><span class="co">#     join_y() |&gt;</span></span>
<span><span class="co">#     summarise_topics(sum_prop = sum(prop), .by = c(luokka, topic)) |&gt;</span></span>
<span><span class="co">#     plot_topic_mean_prop(x = topic, y = sum_prop, colour = luokka)</span></span>
<span><span class="co"># }</span></span>
<span><span class="co"># )</span></span></code></pre></div>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># lapply(doc_topics, function(x) { </span></span>
<span><span class="co">#   x |&gt;</span></span>
<span><span class="co">#     gather_topic_prob() |&gt;</span></span>
<span><span class="co">#     join_y() |&gt;</span></span>
<span><span class="co">#     summarise_topics(mean_prop = mean(prop), .by = c(luokka, topic)) |&gt;</span></span>
<span><span class="co">#     plot_topic_mean_prop(x = topic, y = mean_prop, colour = luokka)</span></span>
<span><span class="co"># }</span></span>
<span><span class="co"># )</span></span></code></pre></div>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># taantuvat |&gt;</span></span>
<span><span class="co">#   filter(kunta %in% unique(aspol$kunta)) |&gt;</span></span>
<span><span class="co">#   mutate(luokka = if_else(suht_muutos_2010_2022 &gt; 0, "Kasvava", "Taantuva")) |&gt;</span></span>
<span><span class="co">#   count(luokka, sort = TRUE)</span></span></code></pre></div>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># purrr::imap(doc_topics, function(x, name) { </span></span>
<span><span class="co">#   x |&gt;</span></span>
<span><span class="co">#     gather_topic_prob() |&gt;</span></span>
<span><span class="co">#     join_y() |&gt;</span></span>
<span><span class="co">#     select(doc_id, topic, prop, suht_muutos_2010_2022, luokka) |&gt;</span></span>
<span><span class="co">#     tidyr::pivot_wider(names_from = topic, values_from = prop) |&gt;</span></span>
<span><span class="co">#     rename_with(~ paste0("topic_", .x, recycle0 = TRUE), matches("^[0-9]+$")) |&gt;</span></span>
<span><span class="co">#     write.csv(paste0("topic_", name, ".csv"))</span></span>
<span><span class="co"># })</span></span></code></pre></div>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># dat &lt;- doc_topics$k_5 |&gt; </span></span>
<span><span class="co">#   gather_topic_prob() |&gt;</span></span>
<span><span class="co">#   join_y() |&gt;</span></span>
<span><span class="co">#   mutate(luokka = if_else(suht_muutos_2010_2022 &gt; 0, "Kasvava", "Taantuva"),</span></span>
<span><span class="co">#          topic = factor(as.integer(topic))) |&gt;</span></span>
<span><span class="co">#   select(topic, prop, luokka)</span></span>
<span><span class="co"># dat</span></span></code></pre></div>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># for (i in seq_along(unique(dat$topic))) {</span></span>
<span><span class="co">#   cat("Topic ", i)</span></span>
<span><span class="co">#   print(</span></span>
<span><span class="co">#     dat |&gt; filter(topic == i) |&gt;</span></span>
<span><span class="co">#     ggplot() +</span></span>
<span><span class="co">#     geom_boxplot(aes(x = luokka, y = prop)) +</span></span>
<span><span class="co">#       labs(title = paste0("Topic ", i))</span></span>
<span><span class="co">#     )</span></span>
<span><span class="co">#   print(</span></span>
<span><span class="co">#     dat |&gt;</span></span>
<span><span class="co">#       filter(topic == i) |&gt;</span></span>
<span><span class="co">#       kruskal.test(luokka ~ prop, data = _)</span></span>
<span><span class="co">#   )</span></span>
<span><span class="co"># } </span></span></code></pre></div>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># doc_topics$k_5 |&gt;</span></span>
<span><span class="co">#   gather_topic_prob() |&gt;</span></span>
<span><span class="co">#   join_y() |&gt;</span></span>
<span><span class="co">#   mutate(luokka = if_else(suht_muutos_2010_2022 &gt; 0, "Kasvava", "Taantuva"),</span></span>
<span><span class="co">#          topic = factor(as.integer(topic))) |&gt;</span></span>
<span><span class="co">#   summarise(topic_sum = sum(prop), </span></span>
<span><span class="co">#             topic_mean = mean(prop),</span></span>
<span><span class="co">#             .by = c(luokka, topic)) |&gt;</span></span>
<span><span class="co">#   kruskal.test(topic_sum ~ luokka)</span></span></code></pre></div>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># lapply(doc_topics, function(x) { </span></span>
<span><span class="co">#   x |&gt;</span></span>
<span><span class="co">#     gather_topic_prob() |&gt;</span></span>
<span><span class="co">#     join_y() |&gt;</span></span>
<span><span class="co">#     mutate(luokka = if_else(suht_muutos_2010_2022 &gt; 0, "Kasvava", "Taantuva"),</span></span>
<span><span class="co">#            topic = factor(as.integer(topic))) |&gt;</span></span>
<span><span class="co">#     summarise(mean_prop = mean(prop), .by = c(luokka, topic)) |&gt;</span></span>
<span><span class="co">#     tidyr::pivot_wider(names_from = luokka, values_from = mean_prop) |&gt;</span></span>
<span><span class="co">#     mutate(diff = Kasvava-Taantuva) |&gt;</span></span>
<span><span class="co">#     ggplot() +</span></span>
<span><span class="co">#     geom_point(aes(x = topic, y = diff)) +</span></span>
<span><span class="co">#     ylim(-0.4, 0.4) +</span></span>
<span><span class="co">#     geom_hline(yintercept = 0)</span></span>
<span><span class="co"># })</span></span></code></pre></div>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># lapply(doc_topics, function(x) { </span></span>
<span><span class="co">#   x |&gt;</span></span>
<span><span class="co">#     gather_topic_prob() |&gt;</span></span>
<span><span class="co">#     join_y() |&gt;</span></span>
<span><span class="co">#     mutate(luokka = if_else(suht_muutos_2010_2022 &gt; 0, "Kasvava", "Taantuva"),</span></span>
<span><span class="co">#            topic = factor(as.integer(topic))) |&gt;</span></span>
<span><span class="co">#     summarise(topic_sum = sum(prop), </span></span>
<span><span class="co">#               topic_mean = mean(prop),</span></span>
<span><span class="co">#               .by = c(luokka, topic)) |&gt;</span></span>
<span><span class="co">#     ggplot() +</span></span>
<span><span class="co">#     geom_tile(aes(x = topic, y = luokka, fill = topic_sum)) +</span></span>
<span><span class="co">#     scale_fill_viridis_c(option = "A")</span></span>
<span><span class="co"># }</span></span>
<span><span class="co"># )</span></span></code></pre></div>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># lapply(doc_topics, function(x) { </span></span>
<span><span class="co">#   x |&gt;</span></span>
<span><span class="co">#     gather_topic_prob() |&gt;</span></span>
<span><span class="co">#     join_y() |&gt;</span></span>
<span><span class="co">#     mutate(luokka = if_else(suht_muutos_2010_2022 &gt; 0, "Kasvava", "Taantuva"),</span></span>
<span><span class="co">#            topic = factor(as.integer(topic))) |&gt;</span></span>
<span><span class="co">#     summarise(topic_sum = sum(prop), </span></span>
<span><span class="co">#               topic_mean = mean(prop),</span></span>
<span><span class="co">#               .by = c(luokka, topic)) |&gt;</span></span>
<span><span class="co">#     ggplot() +</span></span>
<span><span class="co">#     geom_tile(aes(x = topic, y = luokka, fill = topic_mean)) +</span></span>
<span><span class="co">#     scale_fill_viridis_c(option = "A")</span></span>
<span><span class="co"># }</span></span>
<span><span class="co"># )</span></span></code></pre></div>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># lapply(doc_topics, function(x) { </span></span>
<span><span class="co">#   x |&gt;</span></span>
<span><span class="co">#     gather_topic_prob() |&gt;</span></span>
<span><span class="co">#     join_y() |&gt;</span></span>
<span><span class="co">#     mutate(luokka = if_else(suht_muutos_2010_2022 &gt; 0, "Kasvava", "Taantuva"),</span></span>
<span><span class="co">#            topic = factor(as.integer(topic))) |&gt;</span></span>
<span><span class="co">#     summarise(mean_prop = mean(prop), .by = c(luokka, topic)) |&gt;</span></span>
<span><span class="co">#     tidyr::pivot_wider(names_from = luokka, values_from = mean_prop) |&gt;</span></span>
<span><span class="co">#     mutate(diff = Kasvava-Taantuva) |&gt;</span></span>
<span><span class="co">#     tidyr::pivot_longer(Kasvava:Taantuva, names_to = "luokka", values_to = "prop") |&gt;</span></span>
<span><span class="co">#     ggplot() +</span></span>
<span><span class="co">#     geom_tile(aes(x = topic, y = luokka, fill = diff)) +</span></span>
<span><span class="co">#     scale_fill_distiller(palette = "Spectral")</span></span>
<span><span class="co"># })</span></span></code></pre></div>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># titles &lt;- aspol |&gt; </span></span>
<span><span class="co">#   group_by(kunta) |&gt; </span></span>
<span><span class="co">#   slice_head(n=10) |&gt; </span></span>
<span><span class="co">#   summarise(title = paste(FORM, collapse = " ")) |&gt;</span></span>
<span><span class="co">#   inner_join(taantuvat)</span></span>
<span><span class="co"># titles</span></span></code></pre></div>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># titles_per_topics &lt;- lapply(doc_topics, function(x) {</span></span>
<span><span class="co">#   gather_topic_prob(x) |&gt;</span></span>
<span><span class="co">#     slice_max(order_by = prop, n = 1, by = doc_id) |&gt;</span></span>
<span><span class="co">#     left_join(titles, by = join_by("doc_id" == "kunta"))</span></span>
<span><span class="co">#   })</span></span>
<span><span class="co"># titles_per_topics</span></span></code></pre></div>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># titles_per_topics$k_5 |&gt;</span></span>
<span><span class="co">#   filter(topic==3) |&gt;</span></span>
<span><span class="co">#   select(doc_id, title)</span></span></code></pre></div>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># doc_topics$k_5 |&gt; convert(to = "data.frame") |&gt;</span></span>
<span><span class="co">#   tidyr::pivot_longer(!doc_id, names_to = "topic", values_to = "prop") |&gt;</span></span>
<span><span class="co">#   left_join(taantuvat, by = join_by("doc_id" == "kunta")) |&gt;</span></span>
<span><span class="co">#   filter(!is.na(luokka)) |&gt;</span></span>
<span><span class="co">#   group_by(luokka, topic) |&gt;</span></span>
<span><span class="co">#   summarise(mean_prop = mean(prop)) |&gt;</span></span>
<span><span class="co">#   ggplot() +</span></span>
<span><span class="co">#   geom_point(aes(x = topic, y = mean_prop, colour = luokka))</span></span></code></pre></div>
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># doc_topics$k_5 |&gt; convert(to = "data.frame") |&gt;</span></span>
<span><span class="co">#   tidyr::pivot_longer(!doc_id, names_to = "topic", values_to = "prop") |&gt;</span></span>
<span><span class="co">#   ggplot() +</span></span>
<span><span class="co">#   geom_col(aes(x = prop, y = topic))</span></span></code></pre></div>
  </main>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Max Strandén.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
