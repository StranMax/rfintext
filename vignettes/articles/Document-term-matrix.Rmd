---
title: "Document term matrix"
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

Converting tidytext format to numerical matrix form.

```{r setup, message=FALSE, warning=FALSE}
library(rfintext)
# devtools::install_github("StranMax/rfinstats")
library(rfinstats)
library(sf)
library(quanteda)
library(tidytext)
library(stringr)
library(dplyr)
library(readr)
```

```{r}
lemmas <- aspol |>
  filter(UPOSTAG %in% c("NOUN", "VERB", "ADJ"), 
         nchar(LEMMA) > 1,
         !str_detect(LEMMA, "[0-9]"), 
         !kunta %in% c("Enontekiö", "Salla", "Hattula")) |>  # OCR docs problematic
  count(kunta, LEMMA, UPOSTAG, name = "dtf") |>
  # filter(dtf > 1) |>
  bind_tf_idf(LEMMA, kunta, dtf)
```

Let's create variable `y` we are trying to explain with word frequencies.

```{r}
taantuvat <- taantuvat
y <- taantuvat[c("kunta", "suht_muutos_2010_2022")] |>
  inner_join(lemmas[c("kunta")]) |>
  group_by(kunta) |>
  slice(1)
```

We create data with only those docs we have y value

```{r}
data <- left_join(lemmas, y) |>
  filter(!is.na(LEMMA), !is.na(suht_muutos_2010_2022)) |>
  select(kunta, LEMMA, dtf, tf, tf_idf, suht_muutos_2010_2022)

stopifnot(y$kunta_nimi == unique(data$kunta))
```

```{r}
tf <- cast_dfm(data = data, document = kunta, term = LEMMA, value = tf)
tf_idf <- cast_dfm(data = data, document = kunta, term = LEMMA, value = tf_idf)
```


We save 4 objects:

1. ID_labels (kunnat)  
2. Feature_names (LEMMA)  
3. Data (doc-term-matrix)  
4. y-variable (väkiluvun muutos)

```{r}
save_data <- function(X, y, dir_out = tempdir()) {
  
  id_label <-  X |> as.matrix() |> row.names()
  readr::write_lines(id_label, file.path(dir_out, "id_label.txt"), sep = ";")
  
  feature_name <- X |> as.matrix() |> colnames()
  readr::write_lines(feature_name, file.path(dir_out, "feature_name.txt"), sep = ";")
  
  data <- X |> as.matrix() |> as.data.frame()
  readr::write_csv(data, file.path(dir_out, "data.csv"))
  
  label <- y$suht_muutos_2010_2022
  readr::write_lines(label, file.path(dir_out, "label.txt"), sep = ";")
  
  unlink(dir_out)
}
```


```{r}
# save_data(tf, y, dir_out = "C:/Users/maxs/Documents/data/aspol_scikit-learn/tf")
# save_data(tf_idf, y, dir_out = "C:/Users/maxs/Documents/data/aspol_scikit-learn/tf_idf")
```

